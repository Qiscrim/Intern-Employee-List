<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - User Management</title>
    <meta charset="utf-8" />
    <link href="Content/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>
    <link rel="stylesheet" href="admin-dashboardstyles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                Unique Concept
                <span class="admin-badge">🛡️ Administrator Access</span>
            </div>
            <nav class="nav">
                <a href="employee-list.html" class="nav-link active">Employee List</a>
                <a href="add-employee.html" class="nav-link">Add Employee</a>
                <a href="login.html?logout=true" class="nav-link">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <h1 class="page-title">Account Management</h1>
        <p class="page-subtitle">Manage user accounts, roles, and permissions</p>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-header">
                    <span class="stat-title">Total Users</span>
                    <span class="stat-icon"></span>
                </div>
                <div class="stat-value" id="totalUsers">0</div>
            </div>
            <div class="stat-card admins">
                <div class="stat-header">
                    <span class="stat-title">Administrators</span>
                    <span class="stat-icon"></span>
                </div>
                <div class="stat-value" id="totalAdmins">0</div>
            </div>
            <div class="stat-card regular">
                <div class="stat-header">
                    <span class="stat-title">Regular Users</span>
                    <span class="stat-icon"></span>
                </div>
                <div class="stat-value" id="regularUsers">0</div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="management-section">
            <div class="section-header">
                <h2 class="section-title">User Management</h2>
                <button class="add-user-btn" onclick="openAddUserModal()">
                    <span></span>
                    Add New User
                </button>
            </div>

            <!-- Messages -->
            <div id="successMessage" class="message success"></div>
            <div id="errorMessage" class="message error"></div>

            <!-- Controls -->
            <div class="controls-section">
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search users by username or ID...">
                </div>
                <select class="filter-select" id="roleFilter">
                    <option value="all">All Users</option>
                    <option value="admin">Administrators Only</option>
                    <option value="regular">Regular Users Only</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshUsers()"> Refresh</button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                Loading users...
            </div>
            <table class="users-table" id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Authorization</th>
                        <th>Created Date</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be populated here -->
                </tbody>
            </table>
        </div>

    </div>

    <!-- Edit Password Modal -->
    <div id="editPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reset Password</h3>
                <button class="close-btn" onclick="closeEditPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="editUsername" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="text" id="newPassword" class="form-input" placeholder="Enter new password">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditPasswordModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePasswordChange()">Reset Password</button>
            </div>
            <!-- Messages -->
            <div id="successMessage" class="message success"></div>
            <div id="errorMessage" class="message error"></div>
        </div>
    </div>

    <!-- Add User Modal -->
<div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="addUsername" class="form-input" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="text" id="addPassword" class="form-input" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="addRole" class="form-input">
                        <option value="false">Regular User</option>
                        <option value="true">Administrator</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewUser()">Add User</button>
            </div>
        </div>
        <!-- Messages -->
        <div id="successMessage" class="message success"></div>
        <div id="errorMessage" class="message error"></div>
    </div>

    <script>
        let allUsers = [];
        let currentEditUserId = null;
        let currentUser = null; // Store current logged-in user data
        const API_BASE_URL = 'http://localhost:57696/api';

        // Initialize dashboard
        $(document).ready(function () {
            checkAdminAuth();
            loadUsers();
            setupEventListeners();
        });

        // Check if user is authenticated and is admin
        function checkAdminAuth() {
            const currentUserData = localStorage.getItem('currentUser');
            const authToken = localStorage.getItem('authToken');

            console.log('Checking admin auth...');
            console.log('Current user:', currentUserData);
            console.log('Auth token:', authToken ? 'Present' : 'Missing');

            if (!currentUserData || !authToken) {
                console.log('No auth data found, redirecting to login');
                alert('Please login to access this page.');
                window.location.href = 'login.html';
                return false;
            }

            try {
                currentUser = JSON.parse(currentUserData);
                console.log('Parsed user:', currentUser);
                console.log('Is admin:', currentUser.IsAdmin);
                console.log('Is root admin:', currentUser.IsRootAdmin);

                if (!currentUser.IsAdmin) {
                    console.log('User is not admin, access denied');
                    alert('Access denied. Administrator privileges required.');
                    window.location.href = 'employee-list.html';
                    return false;
                }

                // Show root admin indicator if applicable
                if (currentUser.IsRootAdmin) {
                    $('#rootAdminIndicator').show();
                }

                $('.admin-info span:first').text(`Welcome, ${currentUser.Username}`);
                console.log('Admin access granted');
                return true;
            } catch (e) {
                console.error('Error parsing user data:', e);
                alert('Invalid session data. Please login again.');
                window.location.href = 'login.html';
                return false;
            }
        }

        function setupEventListeners() {
            $('#searchInput').on('input', function () {
                filterUsers();
            });

            $('#roleFilter').on('change', function () {
                filterUsers();
            });

            $('.modal').on('click', function (e) {
                if (e.target === this) {
                    $(this).removeClass('show');
                }
            });
        }

        // Load users from API
        function loadUsers() {
            $('#loadingIndicator').show();
            $('#usersTable').hide();
            $('#noUsersMessage').hide();

            $.ajax({
                url: `${API_BASE_URL}/users`,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                },
                success: function (response) {
                    allUsers = response;
                    displayUsers(allUsers);
                    updateStatistics();
                    $('#loadingIndicator').hide();

                    if (allUsers.length === 0) {
                        $('#noUsersMessage').show();
                    } else {
                        $('#usersTable').show();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Failed to load users:', error);
                    $('#loadingIndicator').hide();

                    if (xhr.status === 401) {
                        showError('Session expired. Please login again.');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    } else {
                        showError('Failed to load users. Please try again.');
                    }
                }
            });
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = $('#usersTableBody');
            tbody.empty();

            if (users.length === 0) {
                $('#usersTable').hide();
                $('#noUsersMessage').show();
                return;
            }

            $('#noUsersMessage').hide();
            users.forEach(user => {
                const row = createUserRow(user);
                tbody.append(row);
            });
        }

        // Create user table row - UPDATED with proper root admin protection
        function createUserRow(user) {
            const lastLogin = user.LastLoginDate ?
                formatDate(user.LastLoginDate) :
                '<span class="last-login never">Never</span>';

            const isRecentLogin = user.LastLoginDate &&
                new Date(user.LastLoginDate) > new Date(Date.now() - 24 * 60 * 60 * 1000);

            // Check if this is the current user
            const isSelf = currentUser && currentUser.ID === user.ID;

            // Check if user is root admin
            const isRootAdmin = user.IsRootAdmin === true;

            // Create role badge
            let roleBadge = '';
            if (isRootAdmin) {
                roleBadge = '<span class="root-admin-badge">👑 Root Admin</span>';
            } else if (user.IsAdmin) {
                roleBadge = '<span class="admin-badge">🛡️ Administrator</span>';
            } else {
                roleBadge = '<span class="regular-badge">👤 Regular User</span>';
            }

            // Determine action buttons based on protection status
            let actionButtons = '';
            // Password reset button with protection logic
            if (isRootAdmin && currentUser.IsRootAdmin !== true) {
                // Regular admin cannot reset root admin password
                actionButtons += `<button class="btn-sm btn-disabled" title="Only root administrators can reset root admin passwords">🔒 Protected Password</button>`;
            } else if (isSelf) {
                // Users cannot reset their own password through this interface
                actionButtons += `<button class="btn-sm btn-disabled" title="Use profile settings to change your own password">🚫 Own Password</button>`;
            } else if (user.IsAdmin && currentUser.IsRootAdmin !== true) {
                // Regular admin cannot reset other regular admin passwords
                actionButtons += `<button class="btn-sm btn-disabled" title="Regular administrators cannot reset other admin passwords">🚫 Admin Protected</button>`;
            } else {
                // Password reset available (Root admin can reset anyone's, Regular admin can only reset regular users)
                actionButtons += `<button class="btn-sm btn-reset-password" onclick="openEditPasswordModal(${user.ID}, '${user.Username}')" title="Reset Password">🔑 Reset Password</button>`;
            }

            // Role change button with protection logic
            if (isRootAdmin) {
                // Root admin role cannot be changed by anyone (including themselves)
                actionButtons += `<button class="btn-sm btn-disabled" title="Root admin role cannot be changed">🔒 Protected Role</button>`;
            } else if (isSelf && currentUser.IsRootAdmin !== true) {
                // Regular admin cannot change their own role (but RootAdmin can change their own role if needed)
                actionButtons += `<button class="btn-sm btn-disabled" title="You cannot change your own role">🚫 Self Role</button>`;
            } else {
                // Role toggle available for other users
                // Root admin can change anyone's role except other root admins
                // Regular admin can only change regular users (not other admins)
                const canChangeRole = currentUser.IsRootAdmin === true && !isRootAdmin ||
                                       (currentUser.IsAdmin && currentUser.IsRootAdmin !== true && !user.IsAdmin && !isRootAdmin);

                if (canChangeRole) {
                    const roleActionButton = user.IsAdmin ?
                        `<button class="btn-sm btn-make-user" onclick="toggleUserRole(${user.ID}, '${user.Username}', ${user.IsAdmin})" title="Make Regular User">👤 Make User</button>` :
                        `<button class="btn-sm btn-make-admin" onclick="toggleUserRole(${user.ID}, '${user.Username}', ${user.IsAdmin})" title="Make Administrator">🛡️ Make Admin</button>`;
                    actionButtons += roleActionButton;
                } else {
                    let disabledReason = "Insufficient permissions";
                    if (user.IsAdmin && currentUser.IsRootAdmin !== true) {
                        disabledReason = "Regular admins cannot modify other admin roles";
                    }
                    actionButtons += `<button class="btn-sm btn-disabled" title="${disabledReason}">🚫 No Access</button>`;
                }
            }

            // Delete button with protection logic
            if (isRootAdmin) {
                // Root admin cannot be deleted by anyone
                actionButtons += `<button class="btn-sm btn-disabled" title="Root admin cannot be deleted">🔒 Protected Account</button>`;
            } else if (isSelf) {
                // Users cannot delete themselves
                actionButtons += `<button class="btn-sm btn-disabled" title="You cannot delete yourself">🚫 Self Delete</button>`;
            } else {
                // Delete available for others
                // Root admin can delete anyone except other root admins
                // Regular admin can only delete regular users (not other admins)
                const canDelete = currentUser.IsRootAdmin === true && !isRootAdmin ||
                                  (currentUser.IsAdmin && currentUser.IsRootAdmin !== true && !user.IsAdmin && !isRootAdmin);

                if (canDelete) {
                    actionButtons += `<button class="btn-sm btn-delete" onclick="confirmDeleteUser(${user.ID}, '${user.Username}')" title="Delete User">🗑️ Delete</button>`;
                } else {
                    let disabledReason = "Insufficient permissions";
                    if (user.IsAdmin && currentUser.IsRootAdmin !== true) {
                        disabledReason = "Regular admins cannot delete other administrators";
                    }
                    actionButtons += `<button class="btn-sm btn-disabled" title="${disabledReason}">🚫 No Access</button>`;
                }
            }

            // Apply row classes based on status
            let rowClass = '';
            if (isRootAdmin) {
                rowClass = 'protected-user root-admin-row';
            } else if (isSelf) {
                rowClass = 'self-user';
            } else if (user.IsAdmin) {
                rowClass = 'admin-user';
            }

            // Add protection info
            let protectionInfo = '';
            if (isRootAdmin) {
                protectionInfo = '<div class="protection-info root-admin-info">🔒 Root Administrator</div>';
            } else if (isSelf) {
                protectionInfo = '<div class="protection-info self-info">👤 Your Account</div>';
            }

            return `
        <tr data-user-id="${user.ID}" class="${rowClass}">
            <td><span class="user-id">#${user.ID}</span></td>
            <td>
                <span class="username">${user.Username}</span>
                ${protectionInfo}
            </td>
            <td>${roleBadge}</td>
            <td><span class="created-date">${formatDate(user.CreatedDate)}</span></td>
            <td><span class="last-login ${isRecentLogin ? 'recent' : ''}">${lastLogin}</span></td>
            <td>
                <div class="action-buttons">
                    ${actionButtons}
                </div>
            </td>
        </tr>
    `;
        }


        // Filter users based on search and role
        function filterUsers() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const roleFilter = $('#roleFilter').val();

            let filteredUsers = allUsers;

            // Filter by search term
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    user.Username.toLowerCase().includes(searchTerm) ||
                    user.ID.toString().includes(searchTerm)
                );
            }

            // Filter by role
            if (roleFilter !== 'all') {
                const isAdminFilter = roleFilter === 'admin';
                filteredUsers = filteredUsers.filter(user => user.IsAdmin === isAdminFilter);
            }

            displayUsers(filteredUsers);
        }

        // Update statistics
        function updateStatistics() {
            const totalUsers = allUsers.length;
            const totalAdmins = allUsers.filter(u => u.IsAdmin).length;
            const regularUsers = totalUsers - totalAdmins;

            $('#totalUsers').text(totalUsers);
            $('#totalAdmins').text(totalAdmins);
            $('#regularUsers').text(regularUsers);
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // UPDATED: Toggle user role with enhanced protection checks
        function toggleUserRole(userId, username, currentIsAdmin) {
            // Get target user details
            const targetUser = allUsers.find(u => u.ID === userId);
            if (!targetUser) {
                showError('User not found.');
                return;
            }

            // Enhanced protection checks
            if (targetUser.IsRootAdmin === true) {
                showError('Cannot modify root administrator role. Root admin role is protected.');
                return;
            }

            // Check if current user has permission to change this role
            if (!currentUser.IsRootAdmin && targetUser.IsAdmin) {
                showError('Only root administrators can modify other administrator roles.');
                return;
            }

            // Prevent regular admin from changing their own role
            if (currentUser.ID === userId && currentUser.IsRootAdmin !== true) {
                showError('You cannot change your own role.');
                return;
            }

            const newRole = !currentIsAdmin;
            const actionText = newRole ? 'promote to Administrator' : 'demote to Regular User';

            if (confirm(`Are you sure you want to ${actionText} for user "${username}"?`)) {
                $.ajax({
                    url: `${API_BASE_URL}/users/${userId}/role`,
                    type: 'PUT',
                    contentType: 'application/json',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    },
                    data: JSON.stringify({ IsAdmin: newRole }),
                    success: function (response) {
                        const successMsg = newRole ?
                            `${username} has been promoted to Administrator` :
                            `${username} has been demoted to Regular User`;
                        showSuccess(successMsg);
                        loadUsers(); // Reload to show updated role
                    },
                    error: function (xhr, status, error) {
                        console.error('Role update error:', error);
                        let errorMsg = 'Failed to update user role.';

                        if (xhr.responseJSON && xhr.responseJSON.Message) {
                            errorMsg = xhr.responseJSON.Message;
                        } else if (xhr.status === 403) {
                            errorMsg = 'Access denied. Cannot modify this user\'s role.';
                        } else if (xhr.status === 404) {
                            errorMsg = 'User not found.';
                        } else if (xhr.status === 401) {
                            errorMsg = 'Unauthorized. Please login again.';
                        }

                        showError(errorMsg);
                    }
                });
            }
        }

        // Modal functions
        function openEditPasswordModal(userId, username) {
            currentEditUserId = userId;
            $('#editUsername').val(username);
            $('#newPassword').val('');
            $('#editPasswordModal').addClass('show');
        }

        function closeEditPasswordModal() {
            $('#editPasswordModal').removeClass('show');
            currentEditUserId = null;
        }

        function openAddUserModal() {
            $('#addUsername').val('');
            $('#addPassword').val('');
            $('#addRole').val('false');
            $('#addUserModal').addClass('show');
        }

        function closeAddUserModal() {
            $('#addUserModal').removeClass('show');
        }

        // Save password change
        function savePasswordChange() {
            const newPassword = $('#newPassword').val().trim();

            // Basic validation
            if (!newPassword) {
                showError('Please enter a new password.');
                return;
            }
            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters long.');
                return;
            }

            // Permission checks for password changes
            if (!currentUser.IsAdmin && !currentUser.IsRootAdmin) {
                showError('Administrator access required to reset passwords.');
                return;
            }

            // Cannot change own password through this endpoint
            if (currentUser.ID === currentEditUserId) {
                showError('You cannot reset your own password through this endpoint. Use the profile settings instead.');
                return;
            }

            // FIXED: Ensure we have target user data before proceeding
            if (!targetUser) {
                showError('Unable to verify target user permissions. Please refresh and try again.');
                return;
            }

            // FIXED: More explicit check for root admin protection
            if (targetUser.IsRootAdmin === true && currentUser.IsRootAdmin !== true) {
                showError('Only root administrators can modify root administrator passwords.');
                return;
            }
            // Show loading state
            const $saveBtn = $('#savePasswordBtn');
            const originalText = $saveBtn.text();
            $saveBtn.prop('disabled', true).text('Updating...');

            $.ajax({
                url: `${API_BASE_URL}/users/${currentEditUserId}/password`,
                type: 'PUT',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                },
                data: JSON.stringify({ NewPassword: newPassword }),
                success: function (response) {
                    showSuccess(response.Message || 'Password reset successfully');
                    closeEditPasswordModal();
                },
                error: function (xhr, status, error) {
                    console.error('Password update error:', error);
                    let errorMsg = 'Failed to reset password.';

                    if (xhr.responseJSON && xhr.responseJSON.Message) {
                        errorMsg = xhr.responseJSON.Message;
                    } else if (xhr.status === 404) {
                        errorMsg = 'User not found.';
                    } else if (xhr.status === 401) {
                        errorMsg = 'Unauthorized. Please login again.';
                    }

                    showError(errorMsg);
                }
            });
        }

        // Save new user
        function saveNewUser() {
            const username = $('#addUsername').val().trim();
            const password = $('#addPassword').val().trim();
            const isAdmin = $('#addRole').val() === 'true';

            if (!username) {
                showError('Please enter a username.');
                return;
            }

            if (username.length < 3) {
                showError('Username must be at least 3 characters long.');
                return;
            }

            if (!password) {
                showError('Please enter a password.');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters long.');
                return;
            }

            $.ajax({
                url: `${API_BASE_URL}/users`,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                },
                data: JSON.stringify({
                    Username: username,
                    Password: password,
                    IsAdmin: isAdmin
                }),
                success: function (response) {
                    showSuccess(response.Message || `User "${username}" created successfully!`);
                    closeAddUserModal();
                    loadUsers();
                },
                error: function (xhr, status, error) {
                    console.error('User creation error:', error);
                    let errorMsg = 'Failed to create user.';

                    if (xhr.responseJSON && xhr.responseJSON.Message) {
                        errorMsg = xhr.responseJSON.Message;
                    } else if (xhr.status === 400) {
                        errorMsg = 'Invalid data provided or username already exists.';
                    } else if (xhr.status === 401) {
                        errorMsg = 'Unauthorized. Please login again.';
                    }

                    showError(errorMsg);
                }
            });
        }

        // UPDATED: Confirm delete user with enhanced protection checks
        function confirmDeleteUser(userId, username) {
            // Get target user details
            const targetUser = allUsers.find(u => u.ID === userId);
            if (!targetUser) {
                showError('User not found.');
                return;
            }

            // Enhanced protection checks
            if (targetUser.IsRootAdmin === true) {
                showError('Cannot delete root administrator account. Root admin is protected.');
                return;
            }

            // Check if current user has permission to delete this user
            if (!currentUser.IsRootAdmin && targetUser.IsAdmin) {
                showError('Only root administrators can delete other administrator accounts.');
                return;
            }

            // Prevent self-deletion
            if (currentUser.ID === userId) {
                showError('You cannot delete your own account.');
                return;
            }

            if (confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
                deleteUser(userId, username);
            }
        }

        // Refresh users
        function refreshUsers() {
            showSuccess('Refreshing user data...');
            loadUsers();
        }

        // Message functions
        function showSuccess(message) {
            $('#successMessage').text(message).addClass('show');
            $('#errorMessage').removeClass('show');
            setTimeout(() => {
                $('#successMessage').removeClass('show');
            }, 5000);
        }

        function showError(message) {
            $('#errorMessage').text(message).addClass('show');
            $('#successMessage').removeClass('show');
            setTimeout(() => {
                $('#errorMessage').removeClass('show');
            }, 5000);
        }

        // Keyboard shortcuts
        $(document).keydown(function (e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                $('.modal').removeClass('show');
            }

            // Ctrl+F to focus search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                $('#searchInput').focus();
            }
        });
    </script>
</body>
</html>